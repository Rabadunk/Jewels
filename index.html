<html>
<head>
  <title> Sparky </title>

  <script>
    var connected = false;
    var services_discovered = false;
    var selected_device;
    var connected_server;
    var notifications = false;

    function discoverDevicesOrDisconnect() {
      console.log("discoverDevicesOrDisconnect");
      if (!connected) {
        discoverDevices();
      } else {
        selected_device.gatt.disconnect();
        resetUI();
      }
    }

    function discoverDevices() {
      console.log("discoverDevices");

      var options = {
        filters: [{ namePrefix: 'Lakers' }]
      }

      navigator.bluetooth.requestDevice(options)
                      .then(device => {
                        console.log('> Name: ' + device.name);
                        console.log('> Id: ' + device.id);
                        console.log('> Connected: ' + device.gatt.connected);
                        selected_device = device;
                        console.log(selected_device);
                      })
                      .catch(error => {
                        alert('ERROR: ' + error);
                        console.log('ERROR: ' + error);
                      });
                      connect();
    }

    // This function connects to device.
    function connect() {
        if (connected == false) {
            console.log("connecting");
            selected_device.gatt.connect().then(
                 function (server) {
                     console.log("Connected to " + server.device.id);
                     console.log("connected=" + server.connected);
                      setConnectedStatus(true);    connected_server = server;
                      selected_device.addEventListener( 'gattserverdisconnected', onDisconnected);
                  },   function (error) {
                      console.log("ERROR: could not connect - " + error);
                      alert("ERROR: could not connect - " + error);
                      setConnectedStatus(false);
                  });
              }
    }

    function onDisconnected() {
        console.log("onDisconnected");
        resetUI();
    }

    function resetUI() {
        setConnectedStatus(false);
        setDiscoveryStatus(false);
        setNotificationStatus(false);
        document.getElementById('model_number').innerHTML = "";
        document.getElementById('accelerometer_data').innerHTML = "";
    }

    // This function checks if we're connected to a device.
    function setConnectedStatus(status) {
        connected = status;
        document.getElementById('status_connected').innerHTML= status;
        if (status == true) {
          document.getElementById('btn_scan').innerHTML = "Disconnect";
        } else {
          document.getElementById('btn_scan').innerHTML = "Discover Devies";
        }
    }

    // This function displays our connection status.
    function setDiscoveryStatus(status) {
      services_discovered = status;
      document.getElementById('status_discovered').innerHTML = status;
    }


    function readModelNumber() {
        console.log("readModelNumber");
        // state validation
        if (!connected) {
             alert("Error: Discover and connect to a device before using this function");
             return;
         }

        if (!services_discovered) {
            alert("Error: Service discovery has not yet completed");
            return;
        }

        if (!has_device_information_service) {
            alert("Error: The connected device does not contain the device information service");
            return;
        }
        if (!has_model_name_string) {
            alert("Error: The connected device does not contain the model name string characteristic");
            return;
        }
        model_number_string.readValue().then(value => {
            data = new Uint8Array(value.buffer);
             model_number_string = new TextDecoder("utf-8").decode(data);
             console.log(model_number_string);
             document.getElementById("model_number").innerHTML = model_number_string;
         }) .catch(error => {
             console.log('Error: ' + error);
             alert('Error: ' + error);
             return;
         });
    }

    function setNotificationStatus(status) {
        notifications_enabled = status;
        document.getElementByid('status_notifications').innerHTML = status;
    }

    function getData () {
        console.log("toggleAccelerometerNotifications");
        if(!connected) {
            alert("Error: Discover and connect to a deice before using this function");
            return;
        }

        if(!services_discovered) {
            alert("Error: Service discoverty has not yet completed");
            return;
        }

        if(!has_accelerometer_service) {
            alert("Error: The connected device does not contain the accelerometer service");
            return;
        }

        if(!has_accelerometer_data) {
            alert("Error: The connected device does not contain the acceleromter data characteristic");
            return;
        }
    }

  </script>
</head>

<body>
  <h1>Web Bluetooth</h1>
  <h2>Status</h2>
  <table border="1">
    <tr>
      <td>     <b>Connected</b>    </td>
      <td>     <b>Service Discovery Completed</b>    </td>
      <td>     <b>Notifications</b>    </td>
    </tr>
    <tr>
      <td id="status_connected">false</td>
      <td id="status_discovered">false</td>
      <td id="status_notifications">false</td>
    </tr>
  </table>
    <h2>Device Discovery and Connection</h2>
    <button id="btn_scan" onclick="discoverDevicesOrDisconnect()">Discover Devices</button>
    <hr>
    <h2>Reading and Writing</h2>
    <h3>Read Characteristic - Model Number</h3>
    <button id="btn_read" onclick="readModelNumber()">Read Model Number</button>  <div id="model_number"></div>  <h3>Write Characteristic - Randomise Lights</h3>  <button id="btn_write" onclick="randomLEDs()">Randomise LEDs</button>  <hr>  <h2>Notifications - Accelerometer X, Y, Z</h2>
    <button id="btn_notify" onclick="toggleAccelerometerNotifications()">Toggle Notifications</button>
    <div id="accelerometer_data">
  </div>

</body>
</html>
